
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout | E‑commerce Starter</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- Data Layer bootstrap -->
  <script>
    window.dataLayer = window.dataLayer || [];
    window.digitalData = window.digitalData || {};
  </script>

  <!-- Optional: GTM loader (replace with your GTM ID if you use GTM on checkout) -->
  <!--
  <script>
    (function(w,d,s,l,i){
      w[l]=w[l]||[];
      w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0], j=d.createElement(s), dl=l!='dataLayer'?'&l='+l:'';
      j.async=true; j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
      f.parentNode.insertBefore(j,f);
    })(window, document, 'script', 'dataLayer', 'GTM-XXXXXXX');
  </script>
  -->
</head>
<body>
  <header>
    <div class="container">
      <h1>E‑commerce Starter</h1>
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="t-shirtsindex.html">T‑Shirts</a>
        <a href="sneakerindex.html">Sneakers</a>
        <a href="backpackindex.html">Backpacks</a>
        <a href="about.html" class="nav-link">About Us</a>
        <a href="contact.html" class="nav-link">Contact</a>
        <a href="cart.html" class="nav-link">Cart</a>
        <button class="cta" data-cta-location="header" id="shop-now-btn">Shop Now</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <section>
      <h2>Checkout</h2>
      <div class="checkout-grid">
        <form id="shipping-form">
          <h3>Shipping Info</h3>
          <label>Full Name <input type="text" name="full_name" required /></label>
          <label>Address <input type="text" name="address" required /></label>
          <label>City <input type="text" name="city" required /></label>
          <label>Postal Code <input type="text" name="postal" required /></label>
          <label>Phone <input type="tel" name="phone" required /></label>
          <button type="button" id="save-shipping">Save Shipping</button>
        </form>

        <form id="payment-form">
          <h3>Payment Info</h3>
          <label>Card Number <input type="text" name="card" placeholder="1111 2222 3333 4444" required /></label>
          <label>Expiry <input type="text" name="expiry" placeholder="MM/YY" required /></label>
          <label>CVV <input type="text" name="cvv" placeholder="123" required /></label>
          <button type="button" id="save-payment">Save Payment</button>
        </form>
      </div>

      <div class="order-summary" id="order-summary"></div>
      <div class="cart-actions">
        <a href="cart.html"><button>Back to Cart</button></a>
        <button id="place-order">Place Order</button>
      </div>
    </section>
  </main>

  <footer>
    <div class="container footer-container">
      <a href="https://www.adidas.com" class="outbound-link" target="_blank" rel="noopener">Adidas Official</a>
      <button class="cta" data-cta-location="footer" id="subscribe-btn">Subscribe</button>
      <p>© 2025 Adobe E‑commerce</p>
    </div>
  </footer>

  <!-- Load catalog and cart/GA4 wiring -->
  <script src="catalog.js"></script>
  <script src="app.js"></script>

  <!-- Checkout page logic -->

<script>
  (function(){
    // ---- Page context (object style) ----
    window.digitalData.page = {
      pageInfo: {
        pageName:'checkout',
        title:'Checkout | E‑commerce Starter',
        destinationURL: location.href,
        referringURL: document.referrer || '',
        internalPageName:'checkout',
        pageID:'ga4-starter:checkout',
        sysEnv: navigator.userAgent || ''
      },
      category:{ type:'checkout', primaryCategory:'checkout' },
      language:'en'
    };

    // Push page_context
    window.dataLayer.push({
      event:'page_context',
      page_name: window.digitalData.page.pageInfo.pageName,
      page_title: window.digitalData.page.pageInfo.title,
      page_category: window.digitalData.page.category.primaryCategory,
      page_id: window.digitalData.page.pageInfo.pageID,
      page_language: window.digitalData.page.language
    });

    // ---- Build order summary from Cart ----
    const summaryEl = document.getElementById('order-summary');
    const items = (window.Cart && typeof window.Cart.ga4Items === 'function') ? window.Cart.ga4Items() : [];
    const total = (window.Cart && typeof window.Cart.total === 'function') ? window.Cart.total() : 0;

    if (summaryEl) {
      const lines = items.map(i => {
        const line = (Number(i.price) || 0) * (Number(i.quantity) || 1);
        const name = i.item_name || i.name || i.item_id || 'Item';
        return `<div>${name} x ${i.quantity} — ₹${line}</div>`;
      }).join('');
      summaryEl.innerHTML =
        `<h3>Order Summary</h3>${lines || '<em>No items in cart.</em>'}` +
        `<hr/><strong>Total: ₹${total}</strong>`;
    }

    // Begin checkout (GA4)
    window.dataLayer.push({
      event: 'begin_checkout',
      currency: 'INR',
      value: total,
      items: items
    });

    // ---- Button bindings ----
    const shipBtn = document.getElementById('save-shipping');
    const payBtn  = document.getElementById('save-payment');
    const placeBtn= document.getElementById('place-order');

    if (shipBtn) {
      shipBtn.addEventListener('click', function(){
        window.dataLayer.push({
          event: 'add_shipping_info',
          shipping_tier: 'Standard',
          currency: 'INR',
          value: total,
          items: items
        });
        alert('Shipping info saved (demo).');
      });
    }

    if (payBtn) {
      payBtn.addEventListener('click', function(){
        window.dataLayer.push({
          event: 'add_payment_info',
          payment_type: 'Card',
          currency: 'INR',
          value: total,
          items: items
        });
        alert('Payment info saved (demo).');
      });
    }

    // ---- Order ID utilities (fallback if not present in app.js) ----
    function uuidv4() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    function generateOrderId() { return 'ORD-' + uuidv4(); }

    if (placeBtn) {
      placeBtn.addEventListener('click', function(){
        // Generate and persist order ID
        const orderId = (window.generateOrderId ? window.generateOrderId() : generateOrderId());
        (window.saveLastOrderId ? window.saveLastOrderId(orderId) : localStorage.setItem('last_order_id', orderId));

        // Build Adobe-friendly transaction object
        window.digitalData.transaction = {
          transactionID: orderId,
          currency: 'INR',
          total: total,
          tax: 0,
          shipping: 0,
          paymentMethod: 'Card',
          shippingMethod: 'Standard',
          items: items.map(i => ({
            product: {
              sku: i.item_id,
              name: i.item_name,
              category: i.item_category
            },
            price: i.price,
            quantity: i.quantity
          }))
        };

        // Push GA4 purchase
        window.dataLayer.push({
          event: 'purchase',
          transaction_id: orderId,
          currency: 'INR',
          value: total,
          tax: 0,
          shipping: 0,
          items: items
        });

        // Optional: notify Adobe Launch rules
        window.dataLayer.push({
          event: 'transaction_ready',
          transaction: window.digitalData.transaction
        });

        // Persist snapshot for Thank You page
        const snapshot = { orderId, items: items, total, currency: 'INR', tax: 0, shipping: 0 };
        localStorage.setItem('last_purchase', JSON.stringify(snapshot));
        localStorage.setItem('last_order_id', orderId);

        // Clear cart and redirect to Thank You
        if (window.Cart && typeof window.Cart.clear === 'function') {
          window.Cart.clear();
        }
        alert(`Order placed! (demo) ID: ${orderId}`);
        location.href = 'thankyou.html?order=' + encodeURIComponent(orderId);
      });
    }
  })();
</script>

</body>
</html>
